---
title: Multi-Step Agents
description:
  Advanced agent orchestration with step conditions, workflow management, and
  intelligent execution patterns
icon: robot
---

# Multi-Step Agents

Build sophisticated AI workflows with multi-step agent execution, dynamic step
conditions, and intelligent orchestration patterns for complex reasoning tasks.

## Overview

Multi-step agents enable sophisticated AI workflows where complex tasks are
broken down into manageable steps with intelligent control flow, dynamic model
switching, and comprehensive execution tracking.

## Core Concepts

### Agent Execution Flow

```typescript
import {
  executeMultiStepAgent,
  stepCountAtMost,
  textContains
} from "@repo/ai/server/agents";

const result = await executeMultiStepAgent({
  model: createAnthropicModel("claude-3-5-sonnet-20241022"),
  messages: [
    {
      role: "user",
      content: "Research renewable energy trends and create a report"
    }
  ],
  maxSteps: 10,
  stopWhen: stepCountAtMost(8),
  onStepFinish: ({ stepNumber, result, reasoning }) => {
    console.log(`Step ${stepNumber}:`, result.text);
    if (reasoning) {
      console.log("Reasoning:", reasoning);
    }
  }
});
```

### Step Conditions

Control when to stop agent execution based on content, step count, or custom
logic:

```typescript
import {
  stepCountIs,
  stepCountAtLeast,
  stepCountAtMost,
  textContains,
  textMatches,
  hasToolCall,
  finishReasonIs,
  allConditions,
  anyCondition,
  not
} from "@repo/ai/server/agents";

// Stop after specific step count
const stopAfter5 = stepCountIs(5);

// Stop when task appears complete
const taskComplete = textContains("task completed");

// Stop when analysis is found
const hasAnalysis = textMatches(/analysis|conclusion/i);

// Complex conditions
const complexStop = allConditions([
  stepCountAtLeast(3),
  anyCondition([textContains("final report"), hasToolCall("generate_report")])
]);
```

## Agent Patterns

### Research Agent

Pre-configured agent for research workflows:

```typescript
import { createResearchAgent } from "@repo/ai/server/agents";

const agent = createResearchAgent({
  searchTools: true,
  analysisTools: true,
  summaryGeneration: true,
  maxSearchResults: 10,
  citationRequired: true
});

const research = await executeMultiStepAgent({
  ...agent,
  messages: [
    { role: "user", content: "Research the impact of AI on healthcare" }
  ],
  maxSteps: 8
});
```

### Code Generation Agent

Specialized for software development tasks:

```typescript
import { createCodeGenerationAgent } from "@repo/ai/server/agents";

const codeAgent = createCodeGenerationAgent({
  languages: ["typescript", "python", "sql"],
  testGeneration: true,
  codeReview: true,
  documentation: true
});

const result = await executeMultiStepAgent({
  ...codeAgent,
  messages: [
    { role: "user", content: "Create a REST API for user management" }
  ],
  maxSteps: 12,
  onStepFinish: ({ stepNumber, result }) => {
    // Log each step of code generation
    console.log(`Code generation step ${stepNumber}:`, result.text);
  }
});
```

### Problem-Solving Agent

For complex analytical tasks:

```typescript
import { createProblemSolvingAgent } from "@repo/ai/server/agents";

const solver = createProblemSolvingAgent({
  strategyGeneration: true,
  stepByStepReasoning: true,
  validationRequired: true,
  alternativeSolutions: 3
});

const solution = await executeMultiStepAgent({
  ...solver,
  messages: [
    { role: "user", content: "Optimize our database performance issues" }
  ],
  maxSteps: 15,
  stopWhen: textContains("optimization complete")
});
```

## Agent Controls

### Dynamic Model Switching

Change models based on step requirements:

```typescript
import { createModelSwitchingPrepareStep } from "@repo/ai/server/agents";

const modelSwitcher = createModelSwitchingPrepareStep({
  conditions: [
    {
      when: ({ stepNumber }) => stepNumber <= 3,
      model: "claude-3-5-sonnet-20241022" // Use Sonnet for initial steps
    },
    {
      when: ({ messages }) =>
        messages.some((m) => m.content?.includes("analysis")),
      model: "claude-4-opus-20250514" // Use Opus for analysis
    }
  ],
  fallback: "claude-3-5-sonnet-20241022"
});

const result = await executeMultiStepAgent({
  model: createAnthropicModel("claude-3-5-sonnet-20241022"),
  messages: [
    { role: "user", content: "Analyze market data and provide insights" }
  ],
  maxSteps: 8,
  experimental_prepareStep: modelSwitcher
});
```

### Tool Management

Control tool availability per step:

```typescript
import { createToolLimitingPrepareStep } from "@repo/ai/server/agents";

const toolController = createToolLimitingPrepareStep({
  conditions: [
    {
      when: ({ stepNumber }) => stepNumber <= 2,
      allowedTools: ["search", "web_scrape"]
    },
    {
      when: ({ stepNumber }) => stepNumber > 2,
      allowedTools: ["analyze", "generate_report", "save_file"]
    }
  ]
});

const result = await executeMultiStepAgent({
  model: createAnthropicModel("claude-3-5-sonnet-20241022"),
  messages: [
    { role: "user", content: "Research and create a market analysis report" }
  ],
  tools: {
    search: searchTool,
    web_scrape: scrapeTool,
    analyze: analysisTool,
    generate_report: reportTool,
    save_file: fileTool
  },
  maxSteps: 10,
  experimental_prepareStep: toolController
});
```

### Temperature Adjustment

Adjust creativity based on step context:

```typescript
import { createTemperatureAdjustingPrepareStep } from "@repo/ai/server/agents";

const tempController = createTemperatureAdjustingPrepareStep({
  conditions: [
    {
      when: ({ stepNumber }) => stepNumber <= 3,
      temperature: 0.3 // Low temperature for initial factual steps
    },
    {
      when: ({ messages }) =>
        messages.some((m) => m.content?.includes("creative")),
      temperature: 0.8 // High temperature for creative tasks
    },
    {
      when: ({ stepNumber }) => stepNumber > 8,
      temperature: 0.1 // Very low for final precise steps
    }
  ],
  fallback: 0.5
});
```

## Parallel and Sequential Execution

### Parallel Agents

Run multiple agents concurrently:

```typescript
import { executeParallelAgents } from "@repo/ai/server/agents";

const results = await executeParallelAgents(
  [
    {
      id: "market-research",
      agent: createResearchAgent({ searchTools: true }),
      messages: [{ role: "user", content: "Research market trends" }],
      maxSteps: 5
    },
    {
      id: "competitor-analysis",
      agent: createAnalysisAgent({ deepAnalysis: true }),
      messages: [{ role: "user", content: "Analyze top competitors" }],
      maxSteps: 6
    },
    {
      id: "financial-data",
      agent: createResearchAgent({ dataFocus: true }),
      messages: [{ role: "user", content: "Gather financial metrics" }],
      maxSteps: 4
    }
  ],
  {
    timeout: 300000, // 5 minutes
    concurrency: 3
  }
);

// Results contain data from all parallel executions
console.log("Market research:", results["market-research"]);
console.log("Competitor analysis:", results["competitor-analysis"]);
console.log("Financial data:", results["financial-data"]);
```

### Sequential Workflows

Chain agents where each depends on the previous:

```typescript
import { executeSequentialAgents } from "@repo/ai/server/agents";

const workflow = await executeSequentialAgents([
  {
    id: "data-collection",
    agent: createResearchAgent({ searchTools: true }),
    messages: [{ role: "user", content: "Collect renewable energy data" }],
    maxSteps: 5
  },
  {
    id: "analysis",
    agent: createAnalysisAgent({ statisticalAnalysis: true }),
    // Use results from previous step
    messages: ({ previousResults }) => [
      {
        role: "user",
        content: `Analyze this data: ${previousResults["data-collection"].text}`
      }
    ],
    maxSteps: 8
  },
  {
    id: "report-generation",
    agent: createCommunicationAgent({ reportFormat: "executive-summary" }),
    messages: ({ previousResults }) => [
      {
        role: "user",
        content: `Create executive summary from analysis: ${previousResults["analysis"].text}`
      }
    ],
    maxSteps: 6
  }
]);
```

## Advanced Orchestration

### Conditional Workflows

Create complex decision trees:

```typescript
import { AgentOrchestrator } from "@repo/ai/server/agents";

const orchestrator = new AgentOrchestrator();

// Define workflow with conditional branching
orchestrator.defineWorkflow("market-analysis", {
  steps: [
    {
      id: "initial-research",
      agent: createResearchAgent(),
      condition: () => true // Always run
    },
    {
      id: "deep-analysis",
      agent: createAnalysisAgent({ deepAnalysis: true }),
      condition: ({ previousResults }) =>
        previousResults["initial-research"].text.includes("complex")
    },
    {
      id: "simple-summary",
      agent: createCommunicationAgent({ format: "brief" }),
      condition: ({ previousResults }) =>
        !previousResults["initial-research"].text.includes("complex")
    },
    {
      id: "final-report",
      agent: createCommunicationAgent({ format: "comprehensive" }),
      condition: () => true,
      dependsOn: ["deep-analysis", "simple-summary"]
    }
  ]
});

const result = await orchestrator.executeWorkflow("market-analysis", {
  initialInput: "Analyze the renewable energy market",
  timeout: 600000
});
```

### Multi-Agent Systems

Coordinate multiple specialized agents:

```typescript
import { createMultiAgentSystem } from "@repo/ai/server/agents";

const system = createMultiAgentSystem({
  agents: {
    researcher: createResearchAgent({ searchTools: true }),
    analyst: createAnalysisAgent({ statisticalAnalysis: true }),
    writer: createCommunicationAgent({ style: "technical" }),
    reviewer: createValidationAgent({ checkFactual: true })
  },
  coordinationStrategy: "hierarchical", // or "peer-to-peer", "consensus"
  communicationProtocol: "message-passing"
});

const result = await system.execute({
  task: "Create a comprehensive AI market report",
  coordination: {
    maxRounds: 3,
    consensusThreshold: 0.8,
    timeoutPerRound: 180000
  }
});
```

## Error Handling and Recovery

### Graceful Degradation

Handle failures with fallback strategies:

```typescript
import {
  executeMultiStepAgent,
  createErrorRecovery
} from "@repo/ai/server/agents";

const errorRecovery = createErrorRecovery({
  maxRetries: 3,
  retryDelay: 1000,
  fallbackModel: "claude-3-5-sonnet-20241022",
  gracefulDegradation: true
});

const result = await executeMultiStepAgent({
  model: createAnthropicModel("claude-4-opus-20250514"),
  messages: [{ role: "user", content: "Complex reasoning task" }],
  maxSteps: 10,
  errorRecovery,
  onError: ({ error, stepNumber, recovery }) => {
    console.error(`Step ${stepNumber} failed:`, error.message);
    console.log("Recovery strategy:", recovery.strategy);
  }
});
```

### Step Validation

Validate step outputs before proceeding:

```typescript
const result = await executeMultiStepAgent({
  model: createAnthropicModel("claude-3-5-sonnet-20241022"),
  messages: [{ role: "user", content: "Research and analyze data" }],
  maxSteps: 8,
  stepValidation: {
    validateOutput: (output, stepNumber) => {
      // Ensure each step produces meaningful content
      if (output.text.length < 50) {
        throw new Error(`Step ${stepNumber} output too short`);
      }

      // Validate specific step requirements
      if (stepNumber === 1 && !output.text.includes("research")) {
        throw new Error("First step must include research");
      }

      return true;
    },
    onValidationFail: ({ error, stepNumber, retry }) => {
      console.warn(`Step ${stepNumber} validation failed:`, error.message);
      return retry(); // Retry the step
    }
  }
});
```

## Performance Optimization

### Memory Management

```typescript
import { AgentMemoryManager } from "@repo/ai/server/agents";

const memoryManager = new AgentMemoryManager({
  maxContextSize: 100000, // tokens
  compressionStrategy: "summarization",
  retentionPolicy: "sliding-window"
});

const result = await executeMultiStepAgent({
  model: createAnthropicModel("claude-3-5-sonnet-20241022"),
  messages: [{ role: "user", content: "Long-running analysis task" }],
  maxSteps: 20,
  memoryManager,
  onStepFinish: ({ stepNumber, result }) => {
    // Memory is automatically managed
    console.log(`Step ${stepNumber} memory usage:`, memoryManager.getUsage());
  }
});
```

### Caching and Optimization

```typescript
import { createCachedAgent } from "@repo/ai/server/agents";

const cachedAgent = createCachedAgent({
  cacheKey: ({ messages }) => JSON.stringify(messages),
  ttl: 3600000, // 1 hour
  warmupStrategies: ["precompute-common", "background-refresh"]
});

const result = await executeMultiStepAgent({
  ...cachedAgent,
  model: createAnthropicModel("claude-3-5-sonnet-20241022"),
  messages: [{ role: "user", content: "Frequently requested analysis" }],
  maxSteps: 6
});
```

## Best Practices

### 1. Step Design

- Keep steps focused and atomic
- Use descriptive step conditions
- Implement proper error handling
- Monitor step execution time

### 2. Model Selection

- Use cheaper models for simple steps
- Reserve powerful models for complex reasoning
- Implement dynamic model switching
- Consider cost vs. quality tradeoffs

### 3. Tool Management

- Limit tools per step to relevant ones
- Implement tool permission checking
- Use tool result validation
- Cache expensive tool operations

### 4. Performance

- Set reasonable step limits
- Use streaming for long-running agents
- Implement proper memory management
- Monitor token usage and costs

### 5. Error Handling

- Implement graceful degradation
- Use retry strategies with backoff
- Validate step outputs
- Provide meaningful error messages

## Monitoring and Observability

### Agent Metrics

```typescript
import { AgentPerformanceAnalyzer } from "@repo/ai/server/agents";

const analyzer = new AgentPerformanceAnalyzer();

const result = await executeMultiStepAgent({
  model: createAnthropicModel("claude-3-5-sonnet-20241022"),
  messages: [{ role: "user", content: "Analysis task" }],
  maxSteps: 10,
  onStepFinish: ({ stepNumber, result, timing }) => {
    analyzer.recordStep({
      stepNumber,
      duration: timing.duration,
      tokenUsage: result.usage,
      success: true
    });
  }
});

// Get performance insights
const metrics = analyzer.getMetrics();
console.log("Average step duration:", metrics.averageStepDuration);
console.log("Token efficiency:", metrics.tokensPerStep);
console.log("Success rate:", metrics.successRate);
```

### Debug Logging

```typescript
import { debugUtils } from "@repo/ai/server/agents";

const result = await executeMultiStepAgent({
  model: createAnthropicModel("claude-3-5-sonnet-20241022"),
  messages: [{ role: "user", content: "Debug this workflow" }],
  maxSteps: 8,
  debug: {
    enabled: true,
    logLevel: "detailed",
    includeReasoning: true,
    stepByStepBreakdown: true
  },
  onStepFinish: debugUtils.createStepLogger({
    includeTokenUsage: true,
    includeTimestamp: true,
    formatOutput: "json"
  })
});
```

Multi-step agents provide the foundation for building sophisticated AI workflows
that can handle complex, multi-faceted tasks with intelligent control flow and
robust error handling.
