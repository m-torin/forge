---
title: "Centralized Third-Party Mocks"
description:
  "Learn how to use the centralized third-party mocks system in the @repo/qa
  package"
icon: "boxes"
---

# Centralized Third-Party Mocks

This document explains how to use the centralized third-party mocks system in
the `@repo/qa` package.

## Overview

The centralized mocks system provides consistent mocking for common third-party
packages across the entire monorepo. This eliminates duplication and ensures all
tests have the same mock behavior.

## Available Mock Categories

### 1. UI Framework Mocks

- **@mantine/hooks** - All Mantine hooks with proper browser API simulation
- **@mantine/core** - Component mocks (when needed)

### 2. Next.js Framework Mocks

- **next/navigation** - Router, pathname, search params, etc.
- **next/image** - Image component mock
- **next/cache** - Cache functions (revalidateTag, revalidatePath,
  unstable_cache)
- **server-only** - Server-only module mock

### 3. Theme and Styling Mocks

- **next-themes** - Theme provider and hooks
- **geist** - Font imports
- **CSS imports** - All CSS file types (\*.css, \*.scss, etc.)

### 4. Browser API Mocks

- **window.matchMedia** - Media query matching
- **ResizeObserver** - Element resize observation
- **IntersectionObserver** - Element intersection observation
- **MutationObserver** - DOM mutation observation
- **Element prototypes** - scrollIntoView, pointer events, etc.
- **crypto** - UUID generation and random values

### 5. Utility Library Mocks

- **nanoid** - ID generation

### 6. Internal Package Mocks

- **@repo/analytics** - Analytics tracking and feature flags

### 7. External Service Mocks

- **PostHog** - Analytics and feature flags
- **Segment** - Analytics
- **Vercel Analytics** - Analytics
- **Resend** - Email sending
- **React Email** - Email rendering
- **Knock** - Notifications

### 8. Cloud Storage Mocks

- **@vercel/blob** - Vercel Blob storage
- **AWS SDK** - S3 client and commands

### 9. AI/ML Service Mocks

- **ai** - AI SDK functions
- **@ai-sdk/\*** - All AI provider mocks
- **@upstash/vector** - Vector database

### 10. Workflow and Queue Mocks

- **@upstash/workflow** - Workflow engine
- **@upstash/qstash** - Queue service
- **@upstash/redis** - Redis client

### 11. Observability Mocks

- **@sentry/nextjs** - Error tracking
- **@sentry/node** - Node.js error tracking
- **winston** - Logging

### 12. Environment Mocks

- **@t3-oss/env-nextjs** - Environment validation

## Usage

### Quick Setup Functions

#### `setupAllThirdPartyMocks()`

Sets up comprehensive mock coverage for all categories:

```typescript
import { setupAllThirdPartyMocks } from "@repo/qa";

setupAllThirdPartyMocks();
```

#### `setupEssentialMocks()`

Sets up only the most essential mocks (browser APIs, Mantine, Next.js):

```typescript
import { setupEssentialMocks } from "@repo/qa";

setupEssentialMocks();
```

#### `setupUiMocks()`

Sets up UI-focused mocks (perfect for component testing):

```typescript
import { setupUiMocks } from "@repo/qa";

setupUiMocks();
```

#### `setupServiceMocks()`

Sets up external service mocks (for integration testing):

```typescript
import { setupServiceMocks } from "@repo/qa";

setupServiceMocks();
```

### Individual Category Setup

You can also set up individual categories:

```typescript
import {
  setupBrowserApiMocks,
  setupMantineHooksMocks,
  setupNextJsMocks,
  setupExternalServiceMocks,
  setupStorageMocks,
  setupAiMocks,
  setupWorkflowMocks,
  setupObservabilityMocks
} from "@repo/qa";

// Set up only what you need
setupBrowserApiMocks();
setupMantineHooksMocks();
setupNextJsMocks();
```

## Integration with Vitest Presets

The centralized mocks are automatically integrated into the testing package's
vitest presets:

### nextPreset (Recommended for Next.js apps)

```typescript
// vitest.config.ts
import { defineConfig } from "vitest/config";
import { nextPreset } from "@repo/qa";

export default defineConfig(nextPreset);
```

The `nextPreset` automatically calls `setupUiMocks()` which includes:

- Browser APIs
- Mantine hooks
- Next.js framework mocks
- Theme management
- Font imports
- Internal package mocks

### Custom Setup

For custom setups, import and call the setup functions in your vitest setup
file:

```typescript
// vitest.setup.ts
import "@testing-library/jest-dom";
import { setupUiMocks } from "@repo/qa";

setupUiMocks();

// Your additional custom mocks here
```

## Migration Guide

### From Individual App Setup Files

**Before (app-specific vitest.setup.ts):**

```typescript
import { vi } from "vitest";

// 50+ lines of individual vi.mock() calls
vi.mock("@mantine/hooks", () => ({
  /* ... */
}));
vi.mock("next/navigation", () => ({
  /* ... */
}));
vi.mock("next/image", () => ({
  /* ... */
}));
// ... many more
```

**After (using centralized mocks):**

```typescript
import { vi } from "vitest";
import { setupUiMocks } from "@repo/qa";

setupUiMocks();

// Only app-specific mocks here
vi.mock("#/actions/specific-to-this-app", () => ({
  /* ... */
}));
```

### Benefits of Migration

1. **Consistency** - All apps use the same mock implementations
2. **Maintainability** - Update mocks in one place
3. **Reduced Duplication** - No more copy-pasting mock code
4. **Better Coverage** - Centralized mocks are more comprehensive
5. **Easier Updates** - Update third-party packages without updating every app

## Best Practices

### 1. Use Appropriate Setup Function

- **Component tests**: `setupUiMocks()`
- **Integration tests**: `setupServiceMocks()` + `setupUiMocks()`
- **Unit tests**: `setupEssentialMocks()`
- **Full coverage**: `setupAllThirdPartyMocks()`

### 2. App-Specific Mocks

Keep app-specific mocks in your app's vitest.setup.ts:

```typescript
import { setupUiMocks } from "@repo/qa";

setupUiMocks(); // Centralized mocks

// App-specific mocks
vi.mock("#/actions/app-specific", () => ({
  /* ... */
}));
vi.mock("#/lib/app-specific", () => ({
  /* ... */
}));
```

### 3. Mock Customization

If you need to customize a centralized mock for specific tests:

```typescript
import { vi } from "vitest";

// Override centralized mock for this test
vi.mocked(someFunction).mockReturnValue(customValue);
```

### 4. Environment Variables

Use the environment mocks for consistent test environments:

```typescript
import { setupEnvironmentMocks } from "@repo/qa";

setupEnvironmentMocks();
```

## Troubleshooting

### Mock Not Found Error

If you get "No export is defined on the mock" errors:

1. Check if the export is included in the centralized mocks
2. Add missing exports to your app-specific setup file
3. Consider adding commonly used exports to the centralized mocks

### Mock Conflicts

If centralized mocks conflict with app-specific needs:

1. Override the specific mock in your app's setup file
2. Use `vi.mocked()` to customize behavior in individual tests
3. Consider making the centralized mock more flexible

### Performance Issues

If setup is slow:

1. Use more specific setup functions (`setupEssentialMocks()` vs
   `setupAllThirdPartyMocks()`)
2. Only import what you need
3. Consider lazy loading for heavy mocks

## Contributing

When adding new third-party mocks:

1. Add them to the appropriate category in
   `packages/testing/src/vitest/mocks/third-party.ts`
2. Export them from the category setup function
3. Update this documentation
4. Consider if they should be included in the preset setup functions

### Adding New Categories

1. Create a new setup function (e.g., `setupNewCategoryMocks()`)
2. Add comprehensive mocks for the category
3. Export from the main file
4. Update the all-in-one setup functions if appropriate
5. Document the new category here
