---
title: "Environment Configuration"
description: "AI-optimized guidance for environment variable management"
---

# Environment Configuration - AI Guidance

Simple, clear rules for working with environment variables in the monorepo.

<Info>
  **Complete Implementation Guide**: For detailed patterns and advanced
  features, see the [Architecture Environment Configuration
  Guide](/repo/architecture/environment-configuration).
</Info>

## üö® The Two Rules

### Rule 1: Next.js Apps ‚Üí Direct Access

```typescript
// ‚úÖ ALWAYS do this in Next.js apps
import { env } from "#/root/env";
const apiUrl = env.NEXT_PUBLIC_API_URL; // Webpack inlines this
const dbUrl = env.DATABASE_URL; // Server-only access
```

### Rule 2: Packages ‚Üí Dual Export

```typescript
// ‚úÖ Packages export BOTH patterns
export const env = createEnv({...}); // For Next.js consumers
export function safeEnv() { return env || {...}; } // For Node.js consumers
```

## üö´ Never Do This

```typescript
// ‚ùå Direct process.env access
const key = process.env.API_KEY;

// ‚ùå Using safeEnv() in Next.js apps (breaks webpack inlining)
import { safeEnv } from "#/root/env";
const env = safeEnv();

// ‚ùå Accessing server vars in client components
("use client");
import { env } from "#/root/env";
const secret = env.API_SECRET; // Runtime error!
```

## üìã Quick Templates

### Next.js App Template

```typescript
// apps/*/env.ts
import { createEnv } from "@t3-oss/env-nextjs";
import { z } from "zod/v4";

// Direct export only - no helper functions
export const env = createEnv({
  server: {
    DATABASE_URL: z.string().url(),
    API_SECRET: z.string().min(1)
  },
  client: {
    NEXT_PUBLIC_API_URL: z.string().url()
  },
  runtimeEnv: {
    DATABASE_URL: process.env.DATABASE_URL,
    API_SECRET: process.env.API_SECRET,
    NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL
  }
});
```

### Package Template

```typescript
// packages/*/env.ts
import { createEnv } from "@t3-oss/env-nextjs";
import { z } from "zod/v4";

// Direct export for Next.js webpack inlining
export const env = createEnv({
  server: { API_KEY: z.string().min(1) },
  client: {}, // Most packages don't have client vars
  runtimeEnv: { API_KEY: process.env.API_KEY },
  onValidationError: (error) => {
    console.warn("Package environment validation failed:", error);
    // Don't throw in packages - use fallbacks
  }
});

// Helper for non-Next.js contexts (Node.js, workers, tests)
export function safeEnv() {
  if (env) return env;
  return { API_KEY: process.env.API_KEY || "" };
}
```

## üß† Decision Tree

**Am I working in a Next.js app?**

- **YES** ‚Üí Use `import { env } from "#/root/env"` and access `env.VARIABLE`
  directly
- **NO** ‚Üí
  - **Package** ‚Üí Export both `env` and `safeEnv()`
  - **Node.js script** ‚Üí Use `safeEnv()` from package

## üìÅ File Structure

```
package-or-app/
‚îú‚îÄ‚îÄ env.ts           # Always at root level
‚îî‚îÄ‚îÄ src/
    ‚îî‚îÄ‚îÄ components/  # Import from '../env' or '../../env'
```

## ‚úÖ Usage Examples

### In Next.js Components

```typescript
// Server component
import { env } from "#/root/env";
const dbUrl = env.DATABASE_URL;

// Client component
("use client");
import { env } from "#/root/env";
const apiUrl = env.NEXT_PUBLIC_API_URL;
```

### In Package Code

```typescript
// When consumed by Next.js apps
import { env } from "@repo/analytics/env";
const key = env.POSTHOG_KEY; // Gets inlined by webpack

// When used in Node.js workers
import { safeEnv } from "@repo/analytics/env";
const env = safeEnv();
const key = env.POSTHOG_KEY; // Works without webpack
```

## üêõ Common Errors & Fixes

| Error                               | Fix                                                |
| ----------------------------------- | -------------------------------------------------- |
| `Cannot find module '#/root/env'`   | Create `env.ts` at app root                        |
| `Property 'API_KEY' does not exist` | Add to both schema and `runtimeEnv`                |
| `White screen/app crash`            | Add fallbacks in package `safeEnv()`               |
| `Webpack inlining not working`      | Use direct `env.VARIABLE` not `safeEnv().VARIABLE` |

## üéØ Success Checklist

- [ ] Next.js apps use direct `env.VARIABLE` access
- [ ] Packages export both `env` and `safeEnv()`
- [ ] No `process.env` direct access
- [ ] No `keys.ts` files remain
- [ ] `pnpm typecheck` passes
- [ ] No white screen crashes
