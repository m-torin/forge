---
title: "Environment Configuration"
description: "AI-optimized guidance for environment variable management"
---

# Environment Configuration - AI Guidance

Simple, clear rules for working with environment variables in the monorepo.

<Info>
  **Complete Implementation Guide**: For detailed patterns and advanced
  features, see the [Architecture Environment Configuration
  Guide](/repo/architecture/environment-configuration).
</Info>

## ðŸš¨ The Two Rules

### Rule 1: Next.js Apps â†’ Direct Access

```typescript
// âœ… ALWAYS do this in Next.js apps
import { env } from "#/root/env";
const apiUrl = env.NEXT_PUBLIC_API_URL; // Webpack inlines this
const dbUrl = env.DATABASE_URL; // Server-only access
```

### Rule 2: Packages â†’ Dual Export

```typescript
// âœ… Packages export BOTH patterns
export const env = createEnv({...}); // For Next.js consumers
export function safeEnv() { return env || {...}; } // For Node.js consumers
```

## ðŸš« Never Do This

```typescript
// âŒ Direct process.env access
const key = process.env.API_KEY;

// âŒ Using safeEnv() in Next.js apps (breaks webpack inlining)
import { safeEnv } from "#/root/env";
const env = safeEnv();

// âŒ Accessing server vars in client components
("use client");
import { env } from "#/root/env";
const secret = env.API_SECRET; // Runtime error!
```

## ðŸ“‹ Quick Templates

### Next.js App Template

```typescript
// apps/*/env.ts
import { createEnv } from "@t3-oss/env-nextjs";
import { z } from "zod/v4";

// Direct export only - no helper functions
export const env = createEnv({
  server: {
    DATABASE_URL: z.string().url(),
    API_SECRET: z.string().min(1)
  },
  client: {
    NEXT_PUBLIC_API_URL: z.string().url()
  },
  runtimeEnv: {
    DATABASE_URL: process.env.DATABASE_URL,
    API_SECRET: process.env.API_SECRET,
    NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL
  }
});
```

### Package Template

```typescript
// packages/*/env.ts
import { createEnv } from "@t3-oss/env-nextjs";
import { z } from "zod/v4";

// Direct export for Next.js webpack inlining
export const env = createEnv({
  server: { API_KEY: z.string().min(1) },
  client: {}, // Most packages don't have client vars
  runtimeEnv: { API_KEY: process.env.API_KEY },
  onValidationError: (error) => {
    console.warn("Package environment validation failed:", error);
    // Don't throw in packages - use fallbacks
  }
});

// Helper for non-Next.js contexts (Node.js, workers, tests)
export function safeEnv() {
  if (env) return env;
  return { API_KEY: process.env.API_KEY || "" };
}
```

## ðŸ§  Decision Tree

**Am I working in a Next.js app?**

- **YES** â†’ Use `import { env } from "#/root/env"` and access `env.VARIABLE`
  directly
- **NO** â†’
  - **Package** â†’ Export both `env` and `safeEnv()`
  - **Node.js script** â†’ Use `safeEnv()` from package

## ðŸ“ File Structure

```
package-or-app/
â”œâ”€â”€ env.ts           # Always at root level
â””â”€â”€ src/
    â””â”€â”€ components/  # Import from '../env' or '../../env'
```

## âœ… Usage Examples

### In Next.js Components

```typescript
// Server component
import { env } from "#/root/env";
const dbUrl = env.DATABASE_URL;

// Client component
("use client");
import { env } from "#/root/env";
const apiUrl = env.NEXT_PUBLIC_API_URL;
```

### In Package Code

```typescript
// When consumed by Next.js apps
import { env } from "@repo/analytics/env";
const key = env.POSTHOG_KEY; // Gets inlined by webpack

// When used in Node.js workers
import { safeEnv } from "@repo/analytics/env";
const env = safeEnv();
const key = env.POSTHOG_KEY; // Works without webpack
```

## ðŸ› Common Errors & Fixes

| Error                               | Fix                                                |
| ----------------------------------- | -------------------------------------------------- |
| `Cannot find module '#/root/env'`   | Create `env.ts` at app root                        |
| `Property 'API_KEY' does not exist` | Add to both schema and `runtimeEnv`                |
| `White screen/app crash`            | Add fallbacks in package `safeEnv()`               |
| `Webpack inlining not working`      | Use direct `env.VARIABLE` not `safeEnv().VARIABLE` |

## ðŸŽ¯ Success Checklist

- [ ] Next.js apps use direct `env.VARIABLE` access
- [ ] Packages export both `env` and `safeEnv()`
- [ ] No `process.env` direct access
- [ ] No `keys.ts` files remain
- [ ] `pnpm typecheck` passes
- [ ] No white screen crashes

## ðŸ¤– AI Provider Configuration

### API Key Management

The AI package uses environment variables to determine model availability:

```typescript
// AI provider API keys
OPENAI_API_KEY="your-openai-key"         # OpenAI models
ANTHROPIC_API_KEY="your-anthropic-key"   # Claude models
GOOGLE_AI_API_KEY="your-google-key"      # Gemini models
PERPLEXITY_API_KEY="your-perplexity-key" # Search-enabled models
XAI_API_KEY="your-xai-key"               # Grok models
DEEP_INFRA_API_KEY="your-deepinfra-key"  # Open source models
```

### Model Availability Checking

```typescript
// âœ… Check model availability based on API keys
import {
  isModelAvailable,
  getBestModelForTask,
  selectModel
} from "@repo/ai/models";
import { env } from "#/root/env";

// Model availability depends on configured API keys
if (env.ANTHROPIC_API_KEY) {
  const claudeModel = getBestModelForTask("reasoning");
  if (isModelAvailable(claudeModel)) {
    // Use Claude for reasoning tasks
  }
}

// Automatic fallback when primary provider unavailable
const model = selectModel({
  strategy: "chat",
  userTier: "pro",
  fallbackEnabled: true // Will find best available model
});
```

### Environment-Based Model Selection

```typescript
// âœ… Dynamic model selection based on environment
import { getModelsByProvider, isModelAvailable } from "@repo/ai/models";
import { safeEnv } from "@repo/ai";

const env = safeEnv();

// Get available providers
const availableProviders = [];
if (env.OPENAI_API_KEY) availableProviders.push("openai");
if (env.ANTHROPIC_API_KEY) availableProviders.push("anthropic");
if (env.GOOGLE_AI_API_KEY) availableProviders.push("google");

// Select best model from available providers
const availableModels = availableProviders
  .flatMap((provider) => getModelsByProvider(provider))
  .filter((modelId) => isModelAvailable(modelId));

console.log("Available models:", availableModels);
```
