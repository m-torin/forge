---
title: "Vite/Vitest Configuration Migration Guide"
description:
  "Learn how to migrate from manual Vite/Vitest configurations to the
  centralized testing infrastructure"
---

# Vite/Vitest Configuration Migration Guide

This guide helps you migrate from manual Vite/Vitest configurations to the
centralized testing infrastructure.

## Overview

The `@repo/qa` package now provides:

- **Centralized Vite utilities** for consistent configuration
- **TypeScript-based config builders** with type safety
- **Standardized presets** for common scenarios
- **Shared plugin management** to reduce duplication

## Key Benefits

1. **DRY Principle**: No more duplicate Vite configurations
2. **Type Safety**: Full TypeScript support with proper types
3. **Consistency**: All apps/packages use the same base configuration
4. **Maintainability**: Update Vite config in one place
5. **Best Practices**: Built-in optimizations and standard patterns

## Migration Steps

### 1. From Manual Configuration to Config Builders

#### Before (Manual Configuration)

```typescript
// vitest.config.ts
import { defineConfig } from "vitest/config";
import react from "@vitejs/plugin-react";
import path from "path";

export default defineConfig({
  plugins: [react()],
  test: {
    environment: "jsdom",
    globals: true,
    setupFiles: ["./setup.ts"],
    exclude: ["node_modules", "dist", ".next"]
  },
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src")
    }
  }
});
```

#### After (Using Config Builder)

```typescript
// vitest.config.ts
import { createNextAppConfig } from "@repo/qa/vitest";

export default createNextAppConfig({
  setupFiles: ["./setup.ts"]
});
```

### 2. From Legacy Presets to Modern Builders

#### Before (Using JS Presets)

```typescript
import { defineConfig } from "vitest/config";
import { nextPreset } from "@repo/qa/vitest/presets";

export default defineConfig(nextPreset);
```

#### After (Using TypeScript Builders)

```typescript
import { createNextAppConfig } from "@repo/qa/vitest";

export default createNextAppConfig();
```

### 3. Custom Configurations

#### Adding Custom Plugins

```typescript
import { createNextAppConfig } from "@repo/qa/vitest";
import customPlugin from "vite-plugin-custom";

export default createNextAppConfig({
  overrides: {
    plugins: [customPlugin()]
  }
});
```

#### Custom Coverage Thresholds

```typescript
export default createReactPackageConfig({
  overrides: {
    test: {
      coverage: {
        thresholds: {
          global: {
            branches: 90,
            functions: 90,
            lines: 90,
            statements: 90
          }
        }
      }
    }
  }
});
```

#### Custom Aliases

```typescript
export default createNextAppConfig({
  aliases: {
    "@custom": "./src/custom",
    "#": "./src"
  }
});
```

## Available Config Builders

### `createNextAppConfig(options)`

For Next.js applications. Includes:

- React plugin
- jsdom environment
- Next.js specific mocks
- Standard aliases (`@`, `#/app`, `#/components`, etc.)

### `createReactPackageConfig(options)`

For React packages/libraries. Includes:

- React plugin
- jsdom environment
- CSS modules support
- Browser API mocks

### `createNodePackageConfig(options)`

For Node.js packages. Includes:

- Node environment
- Common Node.js mocks
- Server-side optimizations

### `createDatabasePackageConfig(options)`

For database-related packages. Includes:

- Extended timeouts
- Sequential test execution
- Database-specific environment

### `createQStashPackageConfig(options)`

For queue/QStash packages. Includes:

- QStash environment variables
- Extended timeouts
- Queue-specific setup

## Vite Utilities

### Plugin Management

```typescript
import { getVitePlugins } from "@repo/qa/vitest";

const plugins = getVitePlugins({
  react: true,
  tsconfigPaths: true,
  custom: [myCustomPlugin()]
});
```

### Browser Defines

```typescript
import { createBrowserDefines } from "@repo/qa/vitest";

const defines = createBrowserDefines({
  MY_CUSTOM_VAR: "value"
});
```

### Common Configurations

```typescript
import {
  commonCssConfig,
  commonEsbuildConfig,
  commonOptimizeDeps,
  mergeViteConfig
} from "@repo/qa/vitest";
```

## Common Migration Patterns

### 1. Next.js App with Custom Setup

```typescript
// Old
export default defineConfig({
  plugins: [react()],
  test: {
    environment: "jsdom",
    setupFiles: ["./setup.ts", "./custom-setup.ts"]
  }
  // ... lots of manual config
});

// New
export default createNextAppConfig({
  setupFiles: ["./setup.ts", "./custom-setup.ts"]
});
```

### 2. React Package with High Coverage

```typescript
// Old
export default defineConfig({
  ...reactPreset,
  test: {
    ...reactPreset.test,
    coverage: {
      thresholds: { global: { branches: 95 } }
    }
  }
});

// New
export default createReactPackageConfig({
  overrides: {
    test: {
      coverage: {
        thresholds: { global: { branches: 95 } }
      }
    }
  }
});
```

### 3. Node Package with Custom Environment

```typescript
// Old
export default defineConfig({
  test: {
    environment: "node",
    env: {
      CUSTOM_VAR: "value"
    }
  }
});

// New
export default createNodePackageConfig({
  env: {
    CUSTOM_VAR: "value"
  }
});
```

## Troubleshooting

### Issue: Plugin not found

**Solution**: Make sure the plugin is installed in your package. The centralized
config doesn't install plugins.

### Issue: Custom aliases not working

**Solution**: Use relative paths from your package root, not absolute paths.

### Issue: Environment variables not set

**Solution**: Use the `env` option in the config builder, not `define`.

### Issue: Tests failing after migration

**Solution**: Check that your setup files are still being loaded. The builders
include standard setup, but you need to specify custom ones.

## Best Practices

1. **Start Simple**: Use the basic builder first, then add customizations
2. **Avoid Duplication**: Don't redefine what's already in the builder
3. **Use Overrides Sparingly**: Only override when necessary
4. **Keep Setup Files Small**: Most setup is handled centrally
5. **Document Custom Config**: Add comments explaining why you need overrides

## Need Help?

- Check the [Testing Guide](/repo/development/testing) for general testing help
- Look at examples in other packages
- Ask in the team chat for complex migrations
